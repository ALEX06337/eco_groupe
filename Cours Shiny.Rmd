---
title: "Cours Shiny"
author: "Moi"
date: "2024-09-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```





```{r}
library(shiny)
library(shinyWidgets)
library(quantmod)
library(ggplot2)
library(dplyr)


df1 <- read.csv2("NYSE.csv", header = TRUE, sep = ";")

ui <- fluidPage(
  titlePanel("Analyse et prédiction du cours des actions"),
  hr(),
  actionButton('help','Instruction Book'),
  actionButton('yahoo','Yahoo', onclick = "window.open('https://fr.finance.yahoo.com/', '_blank')"),
  br(),
  br(),
  sidebarLayout(
    sidebarPanel(
      selectizeInput(
        inputId = "entreprise",
        label = "Tapez ou sélectionnez :",
        choices = unique(df1$Description),
        options = list(
            placeholder = "Commencez à taper...",
            create = FALSE
        )
      ),
      
      selectInput('period', "Choice your periode", choices = c('An', 'Trimestre', 'Mois', 'Semaine', 'Jour')),
      
      uiOutput('dynamic_period')
        
    ),
    mainPanel(
      tabsetPanel(
        tabPanel(
          'Plot',
          br(),
          uiOutput('dynamic_var'),
          plotOutput("plot")
        ),
        tabPanel('Table',
                 br(),
                 DT::DTOutput("table")
        )
      )
    )
  )
)


server <- function(input, output) {
  symbol <- reactive({
    df1[df1$Description == input$entreprise, "Symbol"]
  })
  
  recup <- reactive({
    df <- getSymbols(symbol(), src = "yahoo", auto.assign = FALSE)
    df <- data.frame(Date = index(df), coredata(df))
    #df_inverse <- df[nrow(df):1, ]
    return(df)
  })
  
  
  
  observe({
      req(input$search) # Nécessite une entrée utilisateur
      updatePickerInput(
          session = session,
          inputId = "search",
          choices = items[grepl(input$search, items, ignore.case = TRUE)]
      )
  })
  
  
  
  
  
  
  
  
  
  observeEvent(input$help, {
    showModal(modalDialog(
      title = "Mode Action",
      "Entrer le symbole du nom de l'action choisi (le nom entre parenthèse) et le nombre de trimestre pour la prévision")
      )
  })
  
  
 output$dynamic_period <- renderUI({
    numericInput('date', paste('Sur combien de', input$period, 'la prédiction'), value = 2, min = 1)
  })
 
  output$dynamic_var <- renderUI({
    validate(
      need(input$entreprise != "", "\n")
    )
    df <- recup()
    selectInput('var', 'Choice Y', choices = unique(colnames(df[-1])))
  })
  

  
  
  
  
  
  
  
  
  
  
  output$plot <- renderPlot({
    validate(
      need(input$entreprise != "", "Please, enter your entreprise !!")
    )
    ggplot(recup(), aes(x = Date, y = .data[[input$var]])) + geom_line() + labs(title = paste("Prévision de", input$var, "pour", symbol()))
  })

  output$table <- DT::renderDataTable({
    recup()
  })
}

shinyApp(ui = ui, server = server)
```


















```{r}
jour <- c(365,3*30,30,7,1)
names(jour) <- c('An', 'Trimestre', 'Mois', 'Semaine', 'Jour')
jour["An"]

df <- getSymbols("aapl", src = "yahoo", auto.assign = FALSE)
df <- data.frame(Date = index(df), coredata(df))
df

tail(df, n = 10)



  

nui <- 15
n <- 12
nfinal <- n + nui
y <- tail(df[["AAPL.Open"]], n = n)
x <- 1:n
b <- exp(coef(lm(log(y) ~ x))["x"]) # Pente
a <- exp(coef(lm(log(y) ~ x))["(Intercept)"]) # Origine

Ct <- a*b^x
Ctfinal <- a*b^(1:(nfinal))

tableau <- array(y/Ct, dim = c(2, 2, n/4))


Siprime <- function(tableau, sum = 0, Si = 0) {
  nmat <- length(tableau)/4
  for (row in 1:2) {
    for (col in 1:2) {
      for (mat in 1:nmat) {
        sum <- sum + tableau[row,col,mat]
      }
      Si <- c(Si, sum/nmat)
      sum <- 0
    }
  }
  Si <- Si[-1]
  Siprime <- Si/mean(Si)
  return(Siprime)
}

Stfinal <- c(rep(Siprime(tableau), times = (n/4 + (nui-(nui%%4))/4)), Siprime(tableau)[1:(nui%%4)])
modele <- Ctfinal*Stfinal
plot((1:nfinal), modele)
```




